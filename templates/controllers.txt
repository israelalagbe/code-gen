import { Body, Get, JsonController, NotFoundError, Param, Patch, Post, UseBefore } from 'routing-controllers';
import { Validate, RequestUser } from '@letsdeel/employee-tribe-common';
import { Service } from 'typedi';
import { Create{{.ModelName}}Dto, {{.ModelName}}Dto, Update{{.ModelName}}Dto, create{{.ModelName}}Schema, update{{.ModelName}}Schema } from '../data/dto/{{.LowerModelName}}.dto';
import {{.ModelName}}Factory from '../data/factories/{{.LowerModelName}}.factory';
import {{.ModelName}}Mapper from '../data/mappers/{{.LowerModelName}}.mapper';
import {{.ModelName}}Repository from '../data/repositories/{{.LowerModelName}}.repository';
import { MobilityError } from '@shared/errors';
import { Profile } from '@shared/types';
import { AllowAdmin } from '@app/middlewares';

@JsonController('/admin/{{.HypenCaseName}}s')
@Service()
export default class {{.ModelName}}Controller {
  constructor(private {{.LowerModelName}}Repository: {{.ModelName}}Repository, private {{.LowerModelName}}Factory: {{.ModelName}}Factory, private {{.LowerModelName}}Mapper: {{.ModelName}}Mapper) {}

  @Get('/')
  @UseBefore(AllowAdmin())
  async fetchAll(): Promise<{{.ModelName}}Dto[]> {
    const {{.LowerModelName}}s = await this.{{.LowerModelName}}Repository.findAll();

    return {{.LowerModelName}}s.map({{.LowerModelName}} => this.{{.LowerModelName}}Mapper.toResponse({{.LowerModelName}}));
  }

  @Post('/')
  @UseBefore(AllowAdmin(), Validate(create{{.ModelName}}Schema))
  async create(@RequestUser() user: Profile, @Body() payload: Create{{.ModelName}}Dto): Promise<Required<{{.ModelName}}Dto>> {
    const {{.LowerModelName}} = await this.{{.LowerModelName}}Repository.findOneByTemplateKey(payload.templateKey);
    if ({{.LowerModelName}}) {
      throw new MobilityError(`Email {{.LowerModelName}} ${payload.templateKey} already exists.`, 409);
    }

    const entity = this.{{.LowerModelName}}Factory.createFromDto(payload, user);

    await this.{{.LowerModelName}}Repository.insert(entity);

    return this.{{.LowerModelName}}Mapper.toResponse(entity);
  }

  @Patch('/:id')
  @UseBefore(AllowAdmin(), Validate(update{{.ModelName}}Schema))
  async update(@RequestUser() user: Profile, @Param('id') id: string, @Body() payload: Update{{.ModelName}}Dto): Promise<Required<{{.ModelName}}Dto>> {
    const {{.LowerModelName}} = await this.{{.LowerModelName}}Repository.findOneById(id);

    if (!{{.LowerModelName}}) {
      throw new NotFoundError(`Email {{.LowerModelName}} ${id} cannot be found.`);
    }

    {{.LowerModelName}}.set(payload);

    await this.{{.LowerModelName}}Repository.update({{.LowerModelName}});

    return this.{{.LowerModelName}}Mapper.toResponse({{.LowerModelName}});
  }
}